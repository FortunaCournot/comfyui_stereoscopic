name: Install Test (Develop & Main)

on:
  push:
    branches:
      - develop
      - main

jobs:
  test-installation:
    name: Test Installation on Windows
    runs-on: windows-latest
    timeout-minutes: 20   # ‚Üê beendet den Job nach 20 Minuten
    
    env:
      INSTALL_DIR: C:\Users\runneradmin\AppData\Local
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Verify Git Installation
        shell: cmd
        run: |
          git --version

      - name: Verify 7-Zip Installation
        shell: cmd
        run: |
          "C:\Program Files\7-Zip\7z.exe" i

      - name: Install exiftool
        shell: cmd
        run: choco install exiftool -y

      - name: Verify exiftool Installation
        shell: cmd
        run: |
            where exiftool
            exiftool -ver
      
      - name: Ensure FFmpeg is installed
        shell: cmd
        run: |
          choco install ffmpeg -y

      - name: Verify FFmpeg Installation
        shell: cmd
        run: |
          where ffmpeg
          ffmpeg -version

      - name: Setup Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Verify Python Version (pre-install)
        shell: cmd
        run: |
          echo Checking Python before installation:
          where python
          python --version

      - name: Ensure cache directory exists
        shell: cmd
        run: if not exist cache mkdir cache

      - name: Restore cached downloads
        uses: actions/cache@v4
        with:
          path: cache
          key: ${{ runner.os }}-downloads-${{ hashFiles('installer/download_list.txt') }}
          
      - name: Run Installation Script
        shell: cmd
        run: |
          echo Starting installation script with target: %INSTALL_DIR%
          call installer\VrWeAre-Installer.bat "%INSTALL_DIR%"

      - name: Debug cache key
        run: |
          echo Cache key: ${{ runner.os }}-downloads-${{ hashFiles('installer/download_list.txt') }}

      - name: Commit and push updated download list
        if: env.GITHUB_TOKEN != ''
        shell: cmd
        run: |
          echo --- Committing installer\download_list.txt ---
          cd "%GITHUB_WORKSPACE%"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git add installer\download_list.txt

          rem Check if file changed before committing
          git diff --cached --quiet installer\download_list.txt && echo No changes to commit. && exit /b 0

          git commit -m "ci: update download_list.txt (cache) [skip ci]"

          rem Determine current branch
          for /f "delims=" %%B in ('git rev-parse --abbrev-ref HEAD') do set "BRANCH=%%B"

          rem Push changes using GitHub token
          set "AUTH_REMOTE=https://%GITHUB_ACTOR%:%GITHUB_TOKEN%@github.com/%GITHUB_REPOSITORY%.git"
          echo Pushing to %BRANCH%...
          git push "%AUTH_REMOTE%" HEAD:%BRANCH%

      - name: Show committed changes (post-push)
        shell: cmd
        run: |
          echo --- Git status after push ---
          cd "%GITHUB_WORKSPACE%"
          git fetch origin
          git status
          echo.
          echo --- Last commit details ---
          git log -1 --oneline --stat
          echo.
          echo --- installer\download_list.txt contents ---
          type installer\download_list.txt
        