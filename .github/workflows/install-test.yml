name: Install Test (Develop & Main)

on:
  push:
    branches:
      - develop
      - main

jobs:
  test-installation:
    name: Test Installation on Windows
    runs-on: windows-latest
    
    env:
      INSTALL_DIR: C:\Users\runneradmin\AppData\Local
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Verify Git Installation
        shell: cmd
        run: |
          git --version

      - name: Verify 7-Zip Installation
        shell: cmd
        run: |
          "C:\Program Files\7-Zip\7z.exe" i

      - name: Install exiftool
        shell: cmd
        run: choco install exiftool -y

      - name: Verify exiftool Installation
        shell: cmd
        run: |
            where exiftool
            exiftool -ver
      
      - name: Ensure FFmpeg is installed
        shell: cmd
        run: |
          choco install ffmpeg -y

      - name: Verify FFmpeg Installation
        shell: cmd
        run: |
          where ffmpeg
          ffmpeg -version

      - name: Setup Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Verify Python Version (pre-install)
        shell: cmd
        run: |
          echo Checking Python before installation:
          where python
          python --version

      - name: Ensure cache directory exists
        shell: cmd
        run: if not exist %INSTALL_DIR%\cache mkdir %INSTALL_DIR%\cache

      - name: Restore cached downloads
        uses: actions/cache@v4
        with:
          path: ${{ env.INSTALL_DIR }}/cache
          key: ${{ runner.os }}-downloads-${{ hashFiles('installer/download_list.txt') }}
          
      - name: Run Installation Script
        shell: cmd
        run: |
          echo Starting installation script with target: %INSTALL_DIR%
          call installer\VrWeAre-Installer.bat "%INSTALL_DIR%"

      - name: Verify Installation Tests
        shell: cmd
        run: |
          set TEST_DIR=%INSTALL_DIR%\vrweare\ComfyUI_windows_portable\ComfyUI\custom_nodes\comfyui_stereoscopic\.test
          set TEST_FILE=%TEST_DIR%\.install

          echo Checking installation test directory:
          echo %TEST_DIR%

          if exist "%TEST_DIR%" (
              echo Test directory found.
          ) else (
              echo ERROR: Test directory not found! && exit /b 1
          )

          if exist "%TEST_FILE%" (
              echo ERROR: File .install exists – tests NOT successful! && exit /b 1
          ) else (
              echo Tests successful – file .install not present.
          )

      - name: Debug cache key
        run: |
          echo Cache key: ${{ runner.os }}-downloads-${{ hashFiles('installer/download_list.txt') }}

